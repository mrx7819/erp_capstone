{% extends '../index_master.html' %}
{% load static %}
<link href="{% static 'FrWork/admin_lte/build/css/custom.css' %}" rel="stylesheet">

{% block content %}
<div class="right_col" role="main">
    <div class="container mt-5">
        <h1 class="text-center mb-4 text-dark">Agregar Venta</h1>
        
        <div class="form-container p-4 shadow-lg bg-white rounded">
            <form action="{% url 'agregarVenta' %}" method="post" class="agregarVenta-form">
                {% csrf_token %}
                
                <div class="row">
                    <!-- Cliente -->
                    <div class="form-group col-md-6">
                        <label for="cliente">Cliente</label>
                        <select class="form-control" id="cliente" name="cliente" required>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Método de Pago -->
                    <div class="form-group col-md-6">
                        <label for="metodo_pago">Método de Pago</label>
                        <select class="form-control" id="metodo_pago" name="metodo_pago" required>
                            {% for key, value in metodo_pago_choices %}
                                <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <!-- Impuesto -->
                    <div class="form-group col-md-6">
                        <label for="impuesto">Impuesto</label>
                        <input type="text" class="form-control" id="impuesto" name="impuesto_display" value="19%" readonly>
                        <!-- Campo oculto para enviar el impuesto al backend -->
                        <input type="hidden" name="impuesto" value="19">
                    </div>
                    
                    <!-- Estado -->
                    <div class="form-group col-md-6">
                        <label for="estado">Estado</label>
                        <select class="form-control" id="estado" name="estado" required>
                            {% for key, value in estado_choices %}
                                <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <hr>
                <h4 class="text-dark">Detalles de Venta</h4>
                <div id="detalle-container">
                    <div class="detalle-row row mb-2" data-detalle-id="">
                        <div class="form-group col-md-2">
                            <label for="producto">Producto</label>
                            <select class="form-control producto" name="productos[]" required>
                                {% for producto in productos %}
                                    <option value="{{ producto.id }}">{{ producto.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="cantidad">Cantidad</label>
                            <input type="number" class="form-control cantidad" name="cantidades[]" min="1" required>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="precio">Precio Unitario</label>
                            <input type="number" class="form-control precio" name="precios[]" step="0.01" readonly required>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="iva">IVA</label>
                            <input type="text" class="form-control iva" name="iva[]" readonly>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="descuento">Descuento (%)</label>
                            <input type="number" class="form-control descuento" name="descuentos[]" step="0.01" value="0" min="0" max="100">
                        </div>
                        <div class="form-group col-md-2">
                            <label for="total">Total</label>
                            <input type="text" class="form-control total" name="totales[]" readonly>
                        </div>
                    </div>
                </div>

                <button type="button" id="add-detalle" class="btn btn-outline-primary btn-sm">
                    <i class="fa fa-plus"></i> Agregar Detalle
                </button>

                <!-- Submit Button -->
                <div class="text-center mt-4">
                    <a href="{% url 'listarVenta' %}" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left"></i> Volver
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fa fa-plus"></i> Agregar Venta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const detalleContainer = document.getElementById('detalle-container');
        const addDetalleButton = document.getElementById('add-detalle');

        function calculateRowTotal(row) {
            const cantidad = parseFloat(row.querySelector('.cantidad').value) || 0;
            const precio = parseFloat(row.querySelector('.precio').value) || 0;
            const descuento = parseFloat(row.querySelector('.descuento').value) || 0;

            // Calcular subtotal base (sin descuento)
            const subtotalBase = cantidad * precio;
            // Calcular IVA sobre el subtotal base
            const iva = subtotalBase * 0.19;
            // Aplicar descuento al subtotal base + IVA
            const subtotalConIva = subtotalBase + iva;
            const total = Math.max(subtotalConIva * (1 - descuento / 100), 0);

            row.querySelector('.iva').value = `$${iva.toFixed(2)}`;
            row.querySelector('.total').value = `$${total.toFixed(2)}`;
        }

        addDetalleButton.addEventListener('click', function () {
            const newDetalle = detalleContainer.firstElementChild.cloneNode(true);
            newDetalle.querySelectorAll('input').forEach(input => input.value = '');
            newDetalle.querySelectorAll('select').forEach(select => select.value = '');
            newDetalle.removeAttribute('data-detalle-id');
            detalleContainer.appendChild(newDetalle);
        });

        detalleContainer.addEventListener('change', function (event) {
            const row = event.target.closest('.detalle-row');

            if (event.target.classList.contains('producto')) {
                const productoId = event.target.value;
                fetch(`/get-producto-precio/${productoId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            row.querySelector('.precio').value = data.precio_venta;
                            calculateRowTotal(row);
                        } else {
                            alert('No se pudo obtener el precio del producto.');
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }

            if (event.target.classList.contains('cantidad') || event.target.classList.contains('descuento')) {
                calculateRowTotal(row);
            }
        });

        detalleContainer.addEventListener('click', function (event) {
            if (event.target.classList.contains('remove-detalle')) {
                const row = event.target.closest('.detalle-row');
                detalleContainer.removeChild(row);
            }
        });
    });
</script>


{% endblock %}
